<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title}">ブログ記事</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<!-- ===== ローディングアニメ ===== -->
<div id="loading"
     class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent"></div>
</div>

<script>
window.addEventListener("load", () => {
    document.getElementById("loading").style.display = "none";
});
</script>


<!-- ----- ヘッダー ----- -->
<div th:replace="user/layout/header :: siteHeader"></div>

<!-- ----- メイン領域 ----- -->
<main class="max-w-6xl mx-auto px-4 py-10 grid grid-cols-1 md:grid-cols-3 gap-10">

    <!-- ===== 記事本体 ===== -->
    <article class="col-span-2 bg-white shadow rounded-xl p-6">

        <!-- タイトル -->
        <h1 class="text-3xl font-bold text-gray-800 mb-3" th:text="${post.title}"></h1>

        <!-- メタ情報 -->
        <div class="text-sm text-gray-500 mb-6">
            <span th:text="${post.categoryName}"></span> |
            <span th:text="${post.authorName}"></span> |
            <span th:text="${#temporals.format(post.createdAt,'yyyy/MM/dd HH:mm')}"></span>
        </div>

        <!-- サムネイル -->
        <div th:if="${post.imagePath}">
            <img th:src="${post.imagePath}"
                 class="w-full h-80 object-cover rounded-xl shadow mb-8">
        </div>

        <!-- 記事本文（HTMLをそのまま表示） -->
        <div class="prose max-w-none text-gray-800" th:utext="${post.content}"></div>


        <!-- ===== コメント一覧 ===== -->
        <section class="mt-12">
            <h2 class="text-2xl font-bold mb-4">コメント一覧</h2>

            <p th:if="${#lists.isEmpty(comments)}" class="text-gray-500">
                コメントはまだありません。
            </p>

            <!-- コメントループ -->
            <div th:each="c : ${comments}" class="border-b py-4 mb-3 flex gap-4">

                <!-- アイコン -->
                <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold">
                    <span th:text="${c.authorName.substring(0,1)}"></span>
                </div>

                <div class="flex-1">

                    <!-- 名前 -->
                    <p class="font-semibold text-gray-800" th:text="${c.authorName}"></p>

                    <!-- ▼ 通常表示部分 ▼ -->
                    <p class="mt-1 text-gray-700"
                       th:text="${c.content}"
                       th:id="'comment-text-' + ${c.id}">
                    </p>

                    <p class="text-xs text-gray-500 mt-1"
                       th:text="${#temporals.format(c.createdAt,'yyyy/MM/dd HH:mm')}"></p>

                    <!-- ▼ 編集／削除（本人だけ） ▼ -->
                    <div th:if="${isLoggedIn and c.userId == currentUserId}" class="mt-2 flex gap-3">

                        <!-- 編集ボタン -->
                        <button type="button"
                                class="text-blue-600 hover:underline"
                                th:onclick="'showEditForm(' + ${c.id} + ')'">
                            編集
                        </button>

                        <!-- 削除フォーム -->
                        <form th:action="@{/blog/post/{postId}/comment/{cid}/delete(postId=${post.id}, cid=${c.id})}"
                              method="post">
                            <button class="text-red-600 hover:underline"
                                    onclick="return confirm('コメントを削除しますか？');">
                                削除
                            </button>
                        </form>
                    </div>

                    <!-- ▼ 編集フォーム（非表示） ▼ -->
                    <form th:id="'edit-form-' + ${c.id}"
                          th:action="@{/blog/post/{postId}/comment/{cid}/edit(postId=${post.id}, cid=${c.id})}"
                          method="post"
                          class="hidden mt-3">

                        <textarea name="content"
                                  class="w-full border rounded p-2 bg-white"
                                  th:text="${c.content}"></textarea>

                        <button class="mt-2 px-3 py-1 bg-green-600 text-white rounded">
                            保存
                        </button>
                    </form>

                </div>

            </div>

            <!-- ▼ ページネーション ▼ -->
            <div class="flex gap-2 mt-6">
                <a th:each="i : ${#numbers.sequence(0, totalPages-1)}"
                   th:href="@{/blog/post/{id}(id=${post.id}, page=${i})}"
                   th:text="${i + 1}"
                   class="px-3 py-1 rounded border hover:bg-gray-200"
                   th:classappend="${i == currentPage} ? 'bg-blue-600 text-white' : ''">
                </a>
            </div>

        </section>


        <!-- ===== コメント投稿フォーム ===== -->
        <section class="mt-10 bg-gray-50 p-6 rounded-xl">

            <h3 class="text-xl font-bold mb-4">コメントを投稿する</h3>

            <!-- 未ログイン -->
            <div th:if="${!isLoggedIn}">
                <p class="text-gray-700 mb-4">コメントを投稿するにはログインが必要です。</p>

                <a th:href="@{'/login'(redirectTo='/blog/post/' + ${post.id})}"
                   class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    ログインしてコメントを書く
                </a>
            </div>

            <!-- ログイン済み -->
            <form th:if="${isLoggedIn}"
                  th:action="@{/blog/post/{id}/comment(id=${post.id})}"
                  method="post">

                <textarea name="content"
                          class="w-full border rounded-lg p-3 mb-4 bg-white focus:ring"
                          rows="4"
                          placeholder="コメントを入力してください"></textarea>

                <button type="submit"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    コメントを投稿
                </button>

                <p class="text-sm text-green-600 mt-3" th:if="${msg}" th:text="${msg}"></p>
            </form>

        </section>

    </article>

    <!-- ===== サイドバー ===== -->
    <aside class="bg-white shadow rounded-xl p-6">

        <h3 class="text-lg font-semibold mb-4">最近の投稿</h3>

        <div th:each="post : ${recentPosts}" class="mb-4 border-b pb-3">
            <a th:href="@{/blog/post/{id}(id=${post.id})}"
               class="font-semibold text-blue-600 hover:underline"
               th:text="${post.title}"></a>

            <p class="text-xs text-gray-500"
               th:text="${#temporals.format(post.createdAt, 'yyyy/MM/dd')}"></p>
        </div>

    </aside>

</main>


<!-- 編集フォーム表示用 JS -->
<script>
function showEditForm(id) {
    document.getElementById("edit-form-" + id).classList.remove("hidden");
    document.getElementById("comment-text-" + id).classList.add("hidden");
}
</script>

</body>
</html>
